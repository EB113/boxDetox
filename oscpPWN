#!/usr/bin/python3.7

import traceback,pyfiglet
import sys,os
import socket

from src.miscellaneous.config import bcolors, Config
from src.menus.menu import configExport,configImport,moduleExport,moduleImport,profileExport,profileImport


# Check if oscpPWN logger is on!
def checkLogger():
	s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
	try:
		s.connect((Config.LOGGERIP,int(Config.LOGGERPORT)))
		s.shutdown(2)
		return True
	except:
		return False

# Get running PATH
path = os.getcwd()

if len(sys.argv) == 1:
	# BANNER
	print("{}{}{}".format(bcolors.HEADER,pyfiglet.figlet_format("oscpPWN"),bcolors.ENDC))	
	
	# Get directories under ./db/sessions
	first = True
	print("\nSessions Available:")
	for subdirs,dirs,files in os.walk(path+"/db/sessions/"):
		if first:
			first = False
			continue
		session = subdirs.split("/db/sessions/")
		session = session[1].split("/")
		if len(session) == 1:
			print("[*] {}".format(session[0]))
	try:
		sessID = input("Choose/Create a Session:\n>>> ")
	except:
		exit()
	
	# Setup files as directories, load configs
	try:
		if not os.path.isdir(path+"/db/sessions/"+sessID):
			print("{}Configuring Session Data...{}".format(bcolors.OKGREEN,bcolors.ENDC))
			os.mkdir(path+"/db/sessions/"+sessID)
			os.mkdir(path+"/db/sessions/"+sessID+"/profiles")
			configExport(path+"/db/sessions/"+sessID+"/config.json")
			moduleExport(path+"/db/sessions/"+sessID+"/module.json")
			profileExport(path+"/db/sessions/"+sessID+"/profile.json")
		else:
			print("{}Importing Session Data...{}".format(bcolors.OKGREEN,bcolors.ENDC))
			configImport(path+"/db/sessions/"+sessID+"/config.json")
			moduleImport(path+"/db/sessions/"+sessID+"/module.json")
			profileImport(path+"/db/sessions/"+sessID+"/profile.json")
		Config.PATH = path
	except Exception as e:
		print("{}".format(e))
		print("{}".format(traceback.print_exc()))
		print("{}Error initiating session! Check {}/db/sessions permissions.{}".format(bcolors.WARNING,Config.PATH,bcolors.ENDC))
		exit()
		
	print("{}Checking Logger Status...{}".format(bcolors.OKGREEN,bcolors.ENDC))
	status = checkLogger()
	if status:
		Config.LOGGERSTATUS = "True"
		print("{}Listening IP: {}{}".format(bcolors.OKGREEN,Config.LOGGERIP,bcolors.ENDC))	
		print("{}Listening Port: {}{}".format(bcolors.OKGREEN,Config.LOGGERPORT,bcolors.ENDC))	
	else:
		Config.LOGGERSTATUS = "False"	
	print("{}Status:{}{}".format(bcolors.OKGREEN,status,bcolors.ENDC))	
	
	from src.menus.menu import parse,watchdog
	
	# Start main loop
	Config.SESSID = sessID	
	state = "main"
	while state != "exit":
		try:
			state = parse(input(bcolors.BOLD + bcolors.OKGREEN + "["+state+"]>>> " + bcolors.ENDC))
		except Exception as e:
			print("{}".format(e))
			print("{}".format(traceback.print_exc()))
			break

	Config.LOGGERSTATUS = False
	watchdog.flag.set()
	watchdog.join()
	del watchdog
	try:
		configExport(Config.PATH+"/db/sessions/"+sessID+"/config.json")
		moduleExport(Config.PATH+"/db/sessions/"+sessID+"/module.json")
		profileExport(Config.PATH+"/db/sessions/"+sessID+"/profile.json")
	except Exception as e:
		print("{}".format(e))
		print("{}".format(traceback.print_exc()))
		print("{}Error saving session data!{}".format(bcolors.WARNING,bcolors.ENDC))

elif len(sys.argv) == 2:
	if sys.argv[1] == "config":
		os.system(Config.EDITOR+" "+path+"/src/miscellaneous/config.py")
	elif sys.argv[1] == "logger":
		from src import logger
	else:
		print("{}Oy, Wat u Doink m8! ./oscpPWN or ./oscpPWN <config||logger>{}".format(bcolors.WARNING,bcolors.ENDC))

else:
	print("{}Oy, Wat u Doink m8! ./oscpPWN or ./oscpPWN <config||logger>{}".format(bcolors.WARNING,bcolors.ENDC))

exit()
